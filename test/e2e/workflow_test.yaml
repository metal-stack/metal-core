version: '3.5'

networks:
  metal:
    name: metal
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${NETWORK_SUBNET}

volumes:
  nsq-data-volume:

services:
  nsqlookupd:
    image: nsqio/nsq:v1.1.0
    container_name: ${NSQLOOKUPD_CONTAINER_NAME}
    networks:
      - metal
    volumes:
      - nsq-data-volume:/data
    command: /nsqlookupd -log-level error
    ports:
      - "${NSQLOOKUPD_TCP_PORT}"
      - "${NSQLOOKUPD_HTTP_PORT}"

  nsqd:
    image: nsqio/nsq:v1.1.0
    container_name: ${NSQD_CONTAINER_NAME}
    networks:
      - metal
    command: /nsqd -log-level error --lookupd-tcp-address=nsqlookupd:${NSQLOOKUPD_TCP_PORT}
    depends_on:
      - nsqlookupd
    ports:
      - "${NSQD_TCP_PORT}"
      - "${NSQD_HTTP_PORT}"

  rethinkdb:
    build:
      context: rethinkdb
    image: rethinkdb:test
    container_name: ${RETHINKDB_CONTAINER_NAME}
    networks:
      - metal

  metal-core:
    build:
      context: ../..
    image: registry.fi-ts.io/metal/metal-core
    container_name: ${METAL_CORE_CONTAINER_NAME}
    networks:
      - metal
    environment:
      METAL_CORE_ADDRESS: 0.0.0.0
      METAL_CORE_PORT: ${METAL_CORE_PORT}
      METAL_CORE_MQ_ADDRESS: nsqlookupd:${NSQLOOKUPD_HTTP_PORT}
      METAL_CORE_CONTROL_PLANE_IP: ${METAL_API_IP}
      METAL_CORE_SITE_ID: FRA
      METAL_CORE_RACK_ID: Vagrant Rack 1
      METAL_CORE_LOG_LEVEL: DEBUG
      METAL_CORE_METAL_API_ADDRESS: metal-api
      METAL_CORE_METAL_API_PORT: ${METAL_API_PORT}
      METAL_CORE_HAMMER_IMAGE_PREFIX: metal-hammer

  metal-api:
    build:
      context: ../../../maas-service
    image: registry.fi-ts.io/metal/metal-api
    container_name: ${METAL_API_CONTAINER_NAME}
    tty: true
    networks:
      metal:
        ipv4_address: ${METAL_API_IP}
    environment:
      METAL_API_BIND_ADDR: 0.0.0.0
      METAL_API_PORT: ${METAL_API_PORT}
      METAL_API_DB_ADDR: rethinkdb:${RETHINKDB_PORT}
      METAL_API_NETBOX_ADDR: ${NETWORK_GATEWAY}:${NETBOX_PORT}
      METAL_API_NSQD_ADDR: nsqlookupd:${NSQLOOKUPD_TCP_PORT}
      METAL_API_NSQD_HTTP_ADDR: nsqlookupd:${NSQLOOKUPD_HTTP_PORT}
      METAL_API_LOG_LEVEL: debug

  metal-hammer:
    build:
      context: ../../../metal-hammer
      dockerfile: ../metal-core/test/e2e/MetalHammer
    image: registry.fi-ts.io/metal/metal-hammer
    container_name: ${METAL_HAMMER_CONTAINER_NAME}
    networks:
      - metal
